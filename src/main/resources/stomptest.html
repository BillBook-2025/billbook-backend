<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>STOMP Chatroom í…ŒìŠ¤íŠ¸ í´ë¼ì´ì–¸íŠ¸</title>
  <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs"></script>
</head>
<body>
<h2>STOMP Chatroom í…ŒìŠ¤íŠ¸</h2>

<!-- WebSocket ì—°ê²° -->
<label>WebSocket URL: </label>
<input type="text" id="wsUrl" value="ws://localhost:8080/ws" size="40">
<button onclick="connect()">Connect</button>
<button onclick="disconnect()">Disconnect</button>

<!-- Chatroom ID -->
<h3>Chatroom ID</h3>
<input type="number" id="chatroomId" placeholder="ì˜ˆ: 1" size="10">
<button onclick="subscribe()">Subscribe</button>

<!-- ë©”ì‹œì§€ ë³´ë‚´ê¸° -->
<h3>ë©”ì‹œì§€ ë³´ë‚´ê¸°</h3>
<input type="text" id="sendMessage" placeholder="ë³´ë‚¼ ë©”ì‹œì§€" size="40">
<button onclick="sendMessage()">Send</button>

<!-- ë¡œê·¸ì°½ -->
<h3>ë¡œê·¸</h3>
<pre id="log" style="background:#f4f4f4; padding:10px; border:1px solid #ccc; height:300px; overflow:auto;"></pre>

<script>
  let client;
  let subscription;

  function log(message) {
    const logEl = document.getElementById("log");
    logEl.textContent += message + "\n";
    logEl.scrollTop = logEl.scrollHeight;
  }

  function connect() {
    const url = document.getElementById("wsUrl").value;
    client = new StompJs.Client({
      brokerURL: url,
      debug: (str) => log(str),
      reconnectDelay: 5000
    });

    client.onConnect = () => log("âœ… Connected to " + url);
    client.onWebSocketError = (err) => log("âŒ WebSocket Error: " + err);

    client.activate();
  }

  function disconnect() {
    if (subscription) {
      subscription.unsubscribe();
      subscription = null;
    }
    if (client) {
      client.deactivate();
      log("ğŸ”Œ Disconnected");
    }
  }

  function subscribe() {
    const chatroomId = document.getElementById("chatroomId").value;
    if (!chatroomId) {
      alert("Chatroom IDë¥¼ ì…ë ¥í•˜ì„¸ìš”");
      return;
    }

    // ì„œë²„ convertAndSend ê²½ë¡œì™€ ì¼ì¹˜ì‹œí‚¤ê¸°: /topic/chatroom/{id}/chat
    const destination = "/topic/chatroom/" + chatroomId + "/chat";

    if (subscription) subscription.unsubscribe();

    subscription = client.subscribe(destination, (msg) => {
      log("ğŸ“© Received: " + msg.body);
    });

    log("ğŸ“¡ Subscribed to " + destination);
  }

  function sendMessage() {
    const chatroomId = document.getElementById("chatroomId").value;
    const message = document.getElementById("sendMessage").value;
    const senderId = 2; // í…ŒìŠ¤íŠ¸ìš© senderId
    if (!chatroomId) { alert("Chatroom IDë¥¼ ì…ë ¥í•˜ì„¸ìš”"); return; }
    if (!message) { alert("ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”"); return; }

    // MessageDto ìµœì†Œ í•„ë“œ ë§ì¶° JSON ì „ì†¡
    const msgDto = {
      chatRoomId: Number(chatroomId),
      senderId: senderId,
      message: message
    };

    client.publish({
      destination: "/app/chatroom/" + chatroomId + "/chat",
      body: JSON.stringify(msgDto),
      headers: { "content-type": "application/json" }
    });

    log("ğŸ“¤ Sent JSON: " + JSON.stringify(msgDto));
  }
</script>
</body>
</html>

